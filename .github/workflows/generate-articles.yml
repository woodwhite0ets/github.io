name: Generate Articles

on:
  push:
    paths:
      - 'posts/**'  # 当 posts 文件夹有变化时触发

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Install dependencies
        run: npm install @xmldom/xmldom
      
      - name: Generate articles.json
        run: |
          node <<EOF
          const fs = require('fs');
          const path = require('path');
          const { DOMParser } = require('@xmldom/xmldom');
          
          const postsDir = path.join(__dirname, 'posts');
          fs.readdir(postsDir, (err, files) => {
            const articles = files
              .filter(file => path.extname(file) === '.html')
              .map(file => {
                const content = fs.readFileSync(path.join(postsDir, file), 'utf8');
                const doc = new DOMParser().parseFromString(content, 'text/html');
                return {
                  date: doc.querySelector('meta[name="date"]')?.getAttribute('content'),
                  title: doc.querySelector('meta[name="title"]')?.getAttribute('content'),
                  url: `./posts/${file}`
                };
              })
              .filter(article => article.date && article.title)
              .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            fs.writeFileSync('articles.json', JSON.stringify(articles, null, 2));
            console.log('✅ 文章列表已更新');
          });
          EOF
      
      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add articles.json
          git commit -m '自动更新文章列表' || echo "No changes to commit"
          git push